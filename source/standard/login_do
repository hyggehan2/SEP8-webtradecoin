/*
프로젝트e.com 로그인 페이지의 동작을 위한 소스코드입니다. 올바른 사용자인지 확인하고, 로그인을 
위해 사용자가 입력한 정보를 검증합니다. 이를 위한 웹페이지의 동작에 대해 작성합니다. 
*/
//로그인이 되어있다면 로그인이 되어있음을 알리고 새로고침합니다.
<?php
	session_start();
	if(isset($_SESSION['email']))
	{
		echo "<script>alert('로그인 되어 있습니다.')</script>";
		echo "<meta http-equiv=refresh content='0 url=./index.php'>";
		exit();
	}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko" xml:lang="ko">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=euc-kr" />
		<meta name="viewport" content="initial-scale=1.0; maximum-scale=0.75; minimum-scale=1.0; user-scalable=1;width=device-width;"/>
	    <link rel="shortcut icon" type="image/x-icon" href="./icon.ico">
	</head>
/*
로그인 검증: 올바른 사용자가 로그인을 시도하는지 검사하고, 로그인을 위한 필요한 정보를 
입력하였는지 검증합니다. 검증결과 오류가 없다면 사용자는 로그인을 완료할 수 있습니다.
*/
	<body>
		<?php	
			//올바른 사용자인지 검사합니다.
			$ch = curl_init();	
			curl_setopt($ch, CURLOPT_URL, "https://www.google.com/recaptcha/api/siteverify");
			curl_setopt($ch, CURLOPT_POSTFIELDS, "secret=6Lfkl3IUAAAAAC1e7DBAss86mGpe68kAs8D2XkFk&response=".$_POST['g-recaptcha-response']);
			curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); 
			curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0); 
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
			curl_setopt($ch, CURLOPT_POST, 1);
			$robot = json_decode(curl_exec($ch), true);
			curl_close($ch);
			//사용자가 로그인에 필요한 사전정보를 올바르게 작성하는지 검사합니다.
			if($robot["success"] == true)
			{
				$email = $_POST['email'];
				$pass = sha1(sha1(sha1($_POST['pass'])));
				include("config.php");
				$sql =('SELECT * FROM accounts WHERE email="'.mysql_real_escape_string($email).'" and password="'.mysql_real_escape_string($pass).'"');
		
				$result = mysql_query($sql); 
				$cc = mysql_num_rows($result);
				if($cc==1){
					$_SESSION['email']=$email;
					echo "로그인 중입니다.";
					echo "<meta http-equiv=refresh content='0 url=./index.php'>";
					exit();
				}
				else {
					echo "<script>alert('아이디 비밀번호를 확인후 시도하여 주세요.')</script>";
					echo "<meta http-equiv=refresh content='0 url=./login.php'>";
					exit();
				}
			}
			else 
			{
				echo "<script>alert('로봇이 아닙니다. 를 체크하여 주세요.')</script>";
				echo "<meta http-equiv=refresh content='0 url=./login.php'>";
				exit();
			}	
		?>

		?>
	</body>
</html>
